---
import Menu from './Menu.astro'
import '@styles/header.sass'
import '@styles/editor.sass'
import '@styles/notes.sass'
---

<header class="editor-header">
	<button class="export">save as file</button>
	<Menu />
</header>
<main></main>
<script>
	import { Editor, rootCtx } from '@milkdown/kit/core'
	import { clipboard } from '@milkdown/kit/plugin/clipboard'
	import { history } from '@milkdown/kit/plugin/history'
	import { indent } from '@milkdown/kit/plugin/indent'
	import { listener, listenerCtx } from '@milkdown/kit/plugin/listener'
	import { upload } from '@milkdown/kit/plugin/upload'
	import { commonmark } from '@milkdown/kit/preset/commonmark'
	import { getMarkdown } from '@milkdown/utils'
	import { getNotes } from '@stubs/notes'
	import { exportFile } from '@utils/exportFile'
	import { getShortDate } from '@utils/getShortDate'
	import { load } from '@utils/load'
	import { save } from '@utils/save'

	const autosaveInterval = 5_000
	const rootEl: HTMLElement = document.querySelector('main')
	const notes = getNotes()

	let updated = false
	let editorEl: HTMLDivElement = null
	let empty = true

	let start: DOMHighResTimeStamp
	let startList: DOMHighResTimeStamp

	let times = {
		listener: [],
		attribute: [],
		class: [],
		variable: [],
	}

	const editor = await Editor.make()
		.use(commonmark)
		.use(history)
		.use(clipboard)
		.use(upload)
		.use(indent)
		.use(listener)
		.config((ctx) => {
			ctx.set(rootCtx, rootEl)
			const listener = ctx.get(listenerCtx)

			listener.mounted(() => {
				editorEl = document.querySelector('.editor')
				editorEl.dataset.empty = 'true'
				editorEl.ariaLabel = 'Your note'
			})

			listener.updated((ctx, doc) => {
				start = performance.now()
				updated = true
				const time = Math.round(performance.now() - startList) + ' ms'
				console.debug(`Time from key hit: ${time}`)
				times.listener.push(performance.now() - start)

				start = performance.now()
				if (doc.content.size <= 2) {
					editorEl.dataset.empty = 'true'
				} else editorEl.dataset.empty = 'false'
				times.attribute.push(performance.now() - start)

				start = performance.now()
				if (doc.content.size <= 2) {
					editorEl.classList.add('empty')
				} else editorEl.classList.remove('empty')
				times.class.push(performance.now() - start)

				start = performance.now()
				if (doc.content.size <= 2) {
					empty = true
				} else empty = false
				times.variable.push(performance.now() - start)
			})
		})
		.create()

	// editorEl = document.querySelector<HTMLDivElement>('.editor')
	const exportButtonEl = document.querySelector<HTMLButtonElement>('.export')

	if (notes?.length > 0) editorEl.classList.add('collapsed')
	renderNotes(notes)
	load(editor)

	let saver = setInterval(() => {
		if (updated) {
			save(editor.action(getMarkdown()))
			updated = false
		}
	}, autosaveInterval)

	editorEl.focus()
	editorEl.addEventListener('visibilitychange', toggleAutosave)

	const averageTime = (array) =>
		Math.trunc((array.reduce((a, b) => a + b) / array.length) * 1000) + 'Î¼s'

	editorEl.addEventListener('keydown', (e) => {
		startList = performance.now()

		if ((e.ctrlKey || e.metaKey) && e.key === 's') {
			e.preventDefault()
			if (e.repeat) return
			if (e.shiftKey) {
				exportFile(editor.action(getMarkdown()))
			} else {
				save(editor.action(getMarkdown()), 'shortcut')
			}
		}
		if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
			e.preventDefault()
			if (e.repeat) return
			console.debug(`Listener: ${averageTime(times.listener)}`)
			console.debug(`Attributes: ${averageTime(times.attribute)}`)
			console.debug(`Classes: ${averageTime(times.class)}`)
			console.debug(`Variables: ${averageTime(times.variable)}`)
		}
	})

	exportButtonEl.addEventListener('click', () => {
		exportFile(editor.action(getMarkdown()))
	})

	function renderNotes(notes: Note[]) {
		const sortedNotes = notes.sort(
			(a, b) => b.modified.getTime() - a.modified.getTime(),
		)
		if (sortedNotes?.length > 0) {
			console.debug(sortedNotes)
			const notesEl = document.createElement('ul')
			notesEl.classList.add('notes')

			rootEl.appendChild(notesEl)
			for (const note of sortedNotes) {
				const noteEl = document.createElement('li')
				const noteNameEl = document.createElement('span')
				const noteDateEl = document.createElement('span')
				noteNameEl.className = 'name'
				noteDateEl.className = 'date'
				noteNameEl.innerText = note.name
				noteDateEl.innerText = getShortDate(note.modified)

				noteEl.appendChild(noteNameEl)
				noteEl.appendChild(noteDateEl)
				notesEl.appendChild(noteEl)
			}
		}
	}

	function toggleAutosave() {
		if (document.hidden) {
			clearInterval(saver)
		} else {
			saver = setInterval(() => {
				save(editor.action(getMarkdown()))
			}, autosaveInterval)
		}
	}
</script>
